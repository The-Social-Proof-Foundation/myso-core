name: Generate MySo CLI Help Snippets

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 8 * * *" # nightly 08:00 UTC

permissions:
  contents: write

concurrency:
  group: myso-help
  cancel-in-progress: false

jobs:
  build-help:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine latest MySo release tag
        id: release
        run: |
          TAG=$(curl -s https://api.github.com/repos/MystenLabs/myso/releases \
            | jq -r 'map(select(.tag_name | startswith("testnet-")))[0].tag_name')
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Restore cached MySo binary
        id: cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # pin@v5.0.3
        with:
          path: .cache/myso/${{ steps.release.outputs.tag }}/myso
          key: myso-${{ runner.os }}-${{ steps.release.outputs.tag }}

      - name: Download MySo CLI if cache miss
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          mkdir -p ".cache/myso/${TAG}"
          
          # Try different possible asset names
          ASSETS=(
            "myso-mainnet-v${TAG#testnet-v}-ubuntu-x86_64.tgz"
            "myso-testnet-v${TAG#testnet-v}-ubuntu-x86_64.tgz"
            "myso-${TAG}-ubuntu-x86_64.tgz"
            "myso-linux-x86_64"
          )
          
          DOWNLOADED=false
          for ASSET in "${ASSETS[@]}"; do
            URL="https://github.com/MystenLabs/myso/releases/download/${TAG}/${ASSET}"
            echo "Trying: $URL"
            
            if curl -fsSL -o "/tmp/myso-download" "$URL" 2>/dev/null; then
              echo "Successfully downloaded: $ASSET"
              
              # Check if it's a tarball
              if [[ "$ASSET" == *.tgz ]]; then
                tar -xzf /tmp/myso-download -C ".cache/myso/${TAG}/"
                # Find the myso binary in extracted files
                find ".cache/myso/${TAG}/" -name "myso" -type f -executable -exec mv {} ".cache/myso/${TAG}/myso" \;
              else
                mv /tmp/myso-download ".cache/myso/${TAG}/myso"
              fi
              
              chmod +x ".cache/myso/${TAG}/myso"
              DOWNLOADED=true
              break
            fi
          done
          
          if [ "$DOWNLOADED" = false ]; then
            echo "Failed to download myso binary from any known location"
            echo "Available assets for ${TAG}:"
            curl -s "https://api.github.com/repos/MystenLabs/myso/releases/tags/${TAG}" | jq -r '.assets[].name'
            exit 1
          fi
          
          # Verify it's actually a binary
          if ! file ".cache/myso/${TAG}/myso" | grep -q "executable"; then
            echo "Downloaded file is not an executable:"
            file ".cache/myso/${TAG}/myso"
            head -n 5 ".cache/myso/${TAG}/myso"
            exit 1
          fi

      - name: Generate MDX snippets (sh fenced)
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          BIN=".cache/myso/${TAG}/myso"
          OUT_DIR="docs/content/snippets/console-output"
          mkdir -p "$OUT_DIR"

          gen() { # gen <filename> <command...>
            local file="$1"; shift
            { echo '```sh'; "$BIN" "$@"; echo '```'; } > "$OUT_DIR/$file"
            echo " - $OUT_DIR/$file"
          }

          echo "Generating help snippets from $BIN"

          gen "myso-help.mdx" --help
          gen "myso-client-help.mdx" client --help
          gen "myso-client-call-help.mdx" client call --help
          gen "myso-client-ptb-help.mdx" client ptb --help
          gen "myso-replay-help.mdx" replay --help
          gen "myso-keytool-sign-help.mdx" keytool sign --help
          gen "myso-keytool-help.mdx" keytool --help
          gen "myso-move-help.mdx" move --help
          gen "myso-move-build-help.mdx" move build --help
          gen "myso-validator-help.mdx" validator --help
          gen "myso-validator-report-validator-help.mdx" validator report-validator --help

      - name: Diff guard
        id: diff
        run: |
          if git diff --quiet docs/content/snippets/console-output/; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected."
          fi

      - name: Commit & push changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/content/snippets/console-output/*.mdx
          git commit -m "chore(ci): update MySo CLI help snippets (${{ steps.release.outputs.tag }})"
          git push
