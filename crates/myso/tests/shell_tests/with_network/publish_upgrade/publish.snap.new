---
source: crates/myso/tests/shell_tests.rs
assertion_line: 113
---
----- script -----
#!/usr/bin/env bash
# Copyright (c) Mysten Labs, Inc.
# SPDX-License-Identifier: Apache-2.0

# Test a regular publish flow. Each package should have its own `Published.toml`
# for the specified environment.

# B --> A
# C --> B
# C --> A
#
# D --> B
# D --> A
#
# E --> C
# E --> D
#
# We publish A, B, C, D, E in order

add_env_to_toml() {
  echo "[environments]" >> $1/Move.toml
  echo "localnet = \"$chain_id\"" >> $1/Move.toml
}

myso_version=$(myso --version | sed 's/myso \([^-]*\)-.*$/\1/g')
extract_published() {
  echo "=== $@ ==="
  cat "$@" \
    | grep -v 0x \
    | grep -v "^#" \
    | sed "s/$chain_id/CHAIN_ID/g" \
    | sed "s/$myso_version/MYSO_VERSION/g"
  echo "=== End Published.toml ==="
}

chain_id=$(myso client --client.config $CONFIG chain-identifier)

for i in a b c d e
do
  echo ""
  echo "=== publishing $i ==="
  add_env_to_toml $i

  myso client --client.config $CONFIG publish $i > output.log 2>&1 || cat output.log
  extract_published $i/Published.toml
done

----- results -----
success: true
exit_code: 0
----- stdout -----

=== publishing a ===
Downloading from https://github.comthe-social-proof-foundation/myso-core.git
output from `git -c advice.detachedHead=false clone --quiet --sparse --filter=blob:none --no-checkout --depth 1 https://github.comthe-social-proof-foundation/myso-core.git /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d`
  │ remote: Repository not found.
  │ fatal: repository 'https://github.comthe-social-proof-foundation/myso-core.git/' not found
Error while loading dependency /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d/crates/myso-framework/packages/myso-framework: Error while fetching `{ git = "https://...abs/myso.git", path = "crates/myso-framework/packages/myso-framework", rev = "0676e1...9d" }`: error while executing git command `Command { std: GIT_CONFIG_GLOBAL="" "git" "-c" "advice.detachedHead=false" "clone" "--quiet" "--sparse" "--filter=blob:none" "--no-checkout" "--depth" "1" "https://github.comthe-social-proof-foundation/myso-core.git" "/Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d", kill_on_drop: false }`:
ErrorCode(ExitStatus(unix_wait_status(32768)))
=== a/Published.toml ===
=== End Published.toml ===

=== publishing b ===
Downloading from https://github.comthe-social-proof-foundation/myso-core.git
output from `git -c advice.detachedHead=false clone --quiet --sparse --filter=blob:none --no-checkout --depth 1 https://github.comthe-social-proof-foundation/myso-core.git /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d`
  │ remote: Repository not found.
  │ fatal: repository 'https://github.comthe-social-proof-foundation/myso-core.git/' not found
Error while loading dependency /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d/crates/myso-framework/packages/myso-framework: Error while fetching `{ git = "https://...abs/myso.git", path = "crates/myso-framework/packages/myso-framework", rev = "0676e1...9d" }`: error while executing git command `Command { std: GIT_CONFIG_GLOBAL="" "git" "-c" "advice.detachedHead=false" "clone" "--quiet" "--sparse" "--filter=blob:none" "--no-checkout" "--depth" "1" "https://github.comthe-social-proof-foundation/myso-core.git" "/Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d", kill_on_drop: false }`:
ErrorCode(ExitStatus(unix_wait_status(32768)))
=== b/Published.toml ===
=== End Published.toml ===

=== publishing c ===
Downloading from https://github.comthe-social-proof-foundation/myso-core.git
output from `git -c advice.detachedHead=false clone --quiet --sparse --filter=blob:none --no-checkout --depth 1 https://github.comthe-social-proof-foundation/myso-core.git /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d`
  │ remote: Repository not found.
  │ fatal: repository 'https://github.comthe-social-proof-foundation/myso-core.git/' not found
Error while loading dependency /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d/crates/myso-framework/packages/myso-framework: Error while fetching `{ git = "https://...abs/myso.git", path = "crates/myso-framework/packages/myso-framework", rev = "0676e1...9d" }`: error while executing git command `Command { std: GIT_CONFIG_GLOBAL="" "git" "-c" "advice.detachedHead=false" "clone" "--quiet" "--sparse" "--filter=blob:none" "--no-checkout" "--depth" "1" "https://github.comthe-social-proof-foundation/myso-core.git" "/Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d", kill_on_drop: false }`:
ErrorCode(ExitStatus(unix_wait_status(32768)))
=== c/Published.toml ===
=== End Published.toml ===

=== publishing d ===
Downloading from https://github.comthe-social-proof-foundation/myso-core.git
output from `git -c advice.detachedHead=false clone --quiet --sparse --filter=blob:none --no-checkout --depth 1 https://github.comthe-social-proof-foundation/myso-core.git /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d`
  │ remote: Repository not found.
  │ fatal: repository 'https://github.comthe-social-proof-foundation/myso-core.git/' not found
Error while loading dependency /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d/crates/myso-framework/packages/myso-framework: Error while fetching `{ git = "https://...abs/myso.git", path = "crates/myso-framework/packages/myso-framework", rev = "0676e1...9d" }`: error while executing git command `Command { std: GIT_CONFIG_GLOBAL="" "git" "-c" "advice.detachedHead=false" "clone" "--quiet" "--sparse" "--filter=blob:none" "--no-checkout" "--depth" "1" "https://github.comthe-social-proof-foundation/myso-core.git" "/Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d", kill_on_drop: false }`:
ErrorCode(ExitStatus(unix_wait_status(32768)))
=== d/Published.toml ===
=== End Published.toml ===

=== publishing e ===
Downloading from https://github.comthe-social-proof-foundation/myso-core.git
output from `git -c advice.detachedHead=false clone --quiet --sparse --filter=blob:none --no-checkout --depth 1 https://github.comthe-social-proof-foundation/myso-core.git /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d`
  │ remote: Repository not found.
  │ fatal: repository 'https://github.comthe-social-proof-foundation/myso-core.git/' not found
Error while loading dependency /Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d/crates/myso-framework/packages/myso-framework: Error while fetching `{ git = "https://...abs/myso.git", path = "crates/myso-framework/packages/myso-framework", rev = "0676e1...9d" }`: error while executing git command `Command { std: GIT_CONFIG_GLOBAL="" "git" "-c" "advice.detachedHead=false" "clone" "--quiet" "--sparse" "--filter=blob:none" "--no-checkout" "--depth" "1" "https://github.comthe-social-proof-foundation/myso-core.git" "/Users/brandonshaw/.move/git/https___github_com_MystenLabs_myso_git_0676e11409f87c38733863475d0819407b568a9d", kill_on_drop: false }`:
ErrorCode(ExitStatus(unix_wait_status(32768)))
=== e/Published.toml ===
=== End Published.toml ===

----- stderr -----
cat: a/Published.toml: No such file or directory
cat: b/Published.toml: No such file or directory
cat: c/Published.toml: No such file or directory
cat: d/Published.toml: No such file or directory
cat: e/Published.toml: No such file or directory
